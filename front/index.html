<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
</head>
<body>
  hello world
  <canvas id="canvas" width="800" height="800"></canvas>
  <input type="button" id="clean" value="Clean" />
  <script>
    const canvas = document.getElementById("canvas");
    const clean = document.getElementById("clean");

    const ctx = canvas.getContext("2d");
    // TODO: await connection establishment
    const socket = new WebSocket("ws://localhost:9090/room/123");
    let lastPoints = {}

    clean.onclick = () => {
      socket.send(JSON.stringify({type: 2}))
    }

    socket.onmessage = e => {
      mesg = JSON.parse(e.data);

      switch (mesg.type) {
        case 0:
          let i = 0;
          if (lastPoints[mesg.line.ind] === undefined) {
            lastPoints[mesg.line.ind] = [mesg.line.x[0], mesg.line.y[0]];
            i = 1;
          }

          for (;i < mesg.line.x.length; i++) {
            draw(lastPoints[mesg.line.ind][0], lastPoints[mesg.line.ind][1], mesg.line.x[i], mesg.line.y[i])
            lastPoints[mesg.line.ind] = [mesg.line.x[i], mesg.line.y[i]]
          }

          lastPoints[mesg.line.ind] = [mesg.line.x[mesg.line.x.length-1], mesg.line.y[mesg.line.y.length-1]];
          break;
        case 2:
          ctx.clearRect(0, 0, canvas.width, canvas.height);
      }
    };

    let currX = null, currY = null, drawing = false;

    const draw = function(ox, oy, nx, ny) {
      ctx.beginPath();
      ctx.moveTo(ox, oy);
      ctx.lineTo(nx, ny);
      ctx.strokeStyle = "black";
      ctx.lineWidth = 2;
      ctx.stroke();
      ctx.closePath();
    };

    canvas.addEventListener("mousemove", e => { if (drawing) {
      const __newX = e.clientX - canvas.offsetLeft;
      const __newY = e.clientY - canvas.offsetTop;

      if (currX !== null && currY !== null)
        draw(currX, currY, __newX, __newY);

      currX = __newX;
      currY = __newY;

      socket.send(JSON.stringify({
        type: 0,
        line: {
          x: [currX],
          y: [currY],
        }
      }));
    }});

    canvas.addEventListener("mousedown", e => {
      drawing = true;
      currX = e.clientX - canvas.offsetLeft;
      currY = e.clientY - canvas.offsetTop;
      ctx.beginPath();
      ctx.fillStyle = "black";
      ctx.fillRect(currX, currY, 2, 2);
      ctx.closePath();
    });

    canvas.addEventListener("mouseup", e => {
      socket.send(JSON.stringify({type: 1}));
      drawing = false;
      currX = null;
      currY = null;
    });
  </script>
</body>
</html>
